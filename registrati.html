<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/custom.css">
    <style>
      .pop {
        animation: showup 20s ;
      }

      @keyframes showup {
        0% {opacity:0;}
        20% {opacity:1;}
        80% {opacity:1;}
        100% {opacity:0;}
      }
      .round-green {
        border: 4px solid #1DB954;
      }
    </style>
  </head>
  <body onload="loadGenres();">
    <div class="container d-flex justify-content-center" style="height: 100vh;" id="registrazione">
      <form name="regForm" class="p-2" id="reg-form">
        <div class="mb-2">
          <p style="color: white; font-size: 25pt;" class="mt-3" >Crea account</p>
          <p style="color: white; font-size: 15pt;" >E-mail</p>
          <input placeholder="Inserire la tua mail" type="email" class="form-control" id="email" name="email" aria-describedby="emailHelp">
          <div id="emailHelpBlock" class="form-text mt-3 mb-3 d-none" style="color: red;">*Email gia in uso</div>
        </div>
        <p style="color: white; font-size: 15pt;" >Password</p>
        <div class="mb-2">
          <input placeholder="Password" type="password" class="form-control" id="password" name="password">
        </div>
        <div id="passwordHelpBlock" class="form-text mt-3 mb-3" style="color: white;">*La tua password deve contenere almeno 8 caretteri, almeno una lettera maiuscola e almeno un carettere speciale</div>
        <p style="color: white; font-size: 15pt;" >Username</p>
        <input placeholder="Scegliere un username" class="form-control" id="username" aria-describedby="emailHelp" name="username">
        <div id="usernameHelpBlock" class="form-text mt-3 mb-3 d-none" style="color: red;">*Username gia in uso</div>
      <div class="row">
        <div class="col">
          <p style="color: white; font-size: 15pt;" class="mt-3" >Data di nascita:</p>
          <input type="date" id="dateStandard" name="dateStandard" class="date">
        </div>
        <div class="col">
          <p style="color: white; font-size: 15pt;" class="mt-3">Market:</p>
          <select class="form-select mb-3" aria-label="Default select example" name="market">
            <option selected>Scegli il paese</option>
            <option value="1">EN</option>
            <option value="2">IT</option>
            <option value="3">ES</option>
            <option value="4">US</option>
          </select>
        </div>
      </div>
    
        <div class="mb-3 mt-3">
          <button type="submit" class="btn w-100" id="crea">Crea</button>
        </div>
          <a href="#" style="text-decoration: underline; color: white;" id="acc">Hai già un'account?</a>
        
      </form>
      <form name="userPref " class="p-2  d-none" id="user-pref">
        <!--<h1 class="display-1 pop" style="color: white;">Benvenuto</h1>-->
        <div class="mb-2">
          <div class="row">
            <div class="col-8">
              <p style="color: white; font-size: 25pt;" class="mt-3" >Aggiungi i tuoi generi preferiti</p>
            </div>
            <div class="col-4">
              <button type="submit" class="btn" id="avanti" style="float: right; height: 40px; margin-top: 20px;">Avanti</button>
            </div>
          </div>
          
        </div>
        <div class="mb-2">
            <select class="form-select form-select-lg mb-3" aria-label="Large select example" onchange="addGenre(this.value);" id="sel-gen" style="width: 700px;">
                <option value="" selected>Genres</option>
            </select>
          
            <ul class="list-group list-group-horizontal-md" style="max-width: 700px; overflow: scroll;">
                <li class="item d-flex d-none"  id="selected-genres">
                    <label class="form-check-label me-2" id="lbl" for="firstRadio">item</label>
                    <div role="button" id="close-btn" onclick="this.parentElement.remove();">
                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </div>
                </li>
            </ul>
        </div>
        <div class="mb-2">
          <p style="color: white; font-size: 25pt;" class="mt-3" >Aggiungi i tuoi Artisti preferiti</p>
        </div>
        <div class="mb-2">
          <div class="input-group mb-3">
            <input type="text" class="form-control search-artist" placeholder="Ricerca artista" aria-label="Recipient's username" aria-describedby="button-addon2" id="artist-name">
            <button class="btn btn-outline-secondary" type="button" id="button-addon2">Search</button>
          </div>
        </div>
        <div class="mb-2" style=" height: 500px; overflow: scroll;">
          <div class="row" style="max-width: 700px;">
            <div class="col-3  d-none" id="card-list-none">
              <div class="card">
                <div id="select-artist" class="p-art" role="button"><img src="..." class="card-img-top" alt="..." style="border-radius: 200px; width: 150px; height: 150px;"></div>
                <div class="card-body">
                  <h5 class="card-title" style="color: white; text-align: center;"></h5>
                  <p class="id-art d-none"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--
        <div class="mb-2">
          <div class="position-relative bottom-0 m-4 ">
            <div class="progress" role="progressbar" aria-label="Progress" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="height: 1px;">
              <div class="progress-bar" style="width: 50%; background-color: 	#1DB954;"></div>
            </div>
            <button type="button" class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-primary rounded-pill" style="width: 2rem; height:2rem; background-color: 	#1DB954; border: none; color: white;">1</button>
            <button type="button" class="position-absolute top-0 start-50 translate-middle btn btn-sm btn-primary rounded-pill" style="width: 2rem; height:2rem; border: none;">2</button>
            <button type="button" class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-secondary rounded-pill" style="width: 2rem; height:2rem; border: none;">3</button>
          </div>
        </div>-->
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="JavaScript/func.js"></script>
    <script>
      let reg_form = document.getElementById('reg-form');
      let pref_form = document.getElementById('user-pref');
      let artist_id = [];

      reg_form.addEventListener('submit', (e) => {
        e.preventDefault();

        const options = {
          method: "POST",
          mode: "cors",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify(
            {
              email: document.forms['regForm']['email'].value, 
              password: document.forms['regForm']['password'].value,
              username: document.forms['regForm']['username'].value,
              date_of_birth: document.forms['regForm']['dateStandard'].value,
              market: document.forms['regForm']['market'].value

            }
          )
        }

        fetch('http://localhost:3000/addUser', options)
            .then((res) => res.json())
            .then((res) => {
              console.log(res);
              if (res.code == 400) {
                if ((res.type)=="email")
                  document.getElementById('emailHelpBlock').classList.remove('d-none');
                else if ((res.type)=="username")
                  document.getElementById('usernameHelpBlock').classList.remove('d-none');
                else if(res.type=="password")
                  document.getElementById('passwordHelpBlock').innerHTML = res.error;
              } else if (res.code == 201) {
                localStorage.setItem('id_user', res.id);
                reg_form.classList.add('d-none');
                pref_form.classList.remove('d-none');
              }
            })
            .catch((err) => console.log(err));
      });

      async function loadGenres() {
           /* const options =  {
            method: "GET",
            headers: {
                Authorization: localStorage.getItem('api_key')
            }
        }
            fetch('https://api.spotify.com/v1/recommendations/available-genre-seeds',options)
                .then((res) => {
                    if (!res.ok) {
                        if (res.status == 401) {
                            getApiToken()
                                .then((res) => {
                                    localStorage.setItem('api_key', res.token_type+' '+res.access_token);
                                })
                            loadGenres();
                        } else if (res.status == 429) {
                          console.log(res);
                        }
                    } else {
                        return res.json();
                    }
                })
                .then((json) => {
                    console.log(json);
                    let select = document.getElementById('sel-gen');
                    for (let i = 0; i < json.genres.length; i++) {
                        let option = document.createElement('option');
                        option.value = json.genres[i];
                        option.innerHTML = json.genres[i];
                        select.appendChild(option);
                    }
                })
                .catch((err) => console.log(err));

            //console.log(res);*/

                fetch('http://localhost:3000/getGenres',{method:"GET"})
                .then((res)=>res.json())
                .then((json)=>{
                    let select = document.getElementById('sel-gen');
                    for (let i = 0; i < json.genres.length; i++) {
                        let option = document.createElement('option');
                        option.value = json.genres[i];
                        option.innerHTML = json.genres[i];
                        select.appendChild(option);
                    }

                }) 
                .catch((err)=>console.log(err));


        }
        const list = document.getElementById('selected-genres');
        function addGenre(genre) {
            let clone = list.cloneNode(true);

            clone.getElementsByClassName('form-check-label')[0].innerHTML = genre;
            clone.classList.remove('d-none');
            list.before(clone);
        }

        let artistBtn = document.getElementById('button-addon2');

        artistBtn.addEventListener('click', (e) => {
          e.preventDefault();

          let name = document.getElementById('artist-name').value;
          searchArtist(name);
        });

        function searchArtist(name) {
          fetch(`https://api.spotify.com/v1/search?q=artist:${name}&type=artist&market=IT&limit=10`, {method: "GET", headers: {Authorization: localStorage.getItem('api_key')}})
            .then((res) => {
              if (!res.ok) {
                getApiToken().then((res) => {localStorage.setItem('api_key', res.token_type+' '+res.access_token);})
                searchArtist(name);
              } else {
                return res.json();
              }
            }).then((artists) => {
              //console.log(artists);
              document.querySelectorAll('[id=card-list]').forEach((element) => element.remove());

              let card = document.getElementById('card-list-none');
              for (let i = 0; i < artists.artists.items.length; i++) {
                let clone = card.cloneNode(true);
                clone.id = 'card-list';

                clone.getElementsByClassName('card-img-top')[0].src = artists.artists.items[i].images[1].url;
                clone.getElementsByClassName('card-title')[0].innerHTML = artists.artists.items[i].name;
                clone.getElementsByClassName('id-art')[0].innerHTML = artists.artists.items[i].id;

                clone.getElementsByClassName('p-art')[0].addEventListener('click',(e) => {
                  e.preventDefault()
                  //console.log("Hello from"+ clone.getElementsByClassName('card-title')[0].innerHTML);
                  console.log(clone.getElementsByClassName('card-img-top')[0].classList[1]);

                  if (clone.getElementsByClassName('card-img-top')[0].classList[1] == 'round-green') {
                    clone.getElementsByClassName('card-img-top')[0].classList.remove('round-green');
                    clone.id = 'card-list';
                    const index = artist_id.indexOf(clone.getElementsByClassName('id-art')[0].innerHTML);
                    if (index > -1) {
                      artist_id.splice(index, 1);
                    }
                  } else {
                    clone.getElementsByClassName('card-img-top')[0].classList.add('round-green');
                    clone.id = 'card-list-pref';
                    artist_id.push( clone.getElementsByClassName('id-art')[0].innerHTML);
                  }
                  console.log(artist_id);

                });

                clone.classList.remove('d-none');
                card.before(clone);
              }
              

            }).catch((err) => console.log(err));
        }

      function save() {
        var ul = document.getElementsByTagName('ul');
        var li = ul[0].getElementsByTagName('li');
        var genres_pref = [];
        for (var i = 0; i < li.length - 1; i++) {
          genres_pref.push(li[i].innerText);
        }

        const options = {
          method: "POST",
          mode: "cors",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify(
            {
              id: localStorage.getItem('id_user'),
              liked_artist: artist_id
            }
          )
        }

        fetch('http://localhost:3000/addLikedArtist', options)
          .then((res) => res.json())
          .then((json) => window.location = 'home.html');
        
        //console.log(genres_pref);

      }

      document.getElementById('avanti').addEventListener('click', (e) => {
        e.preventDefault();
        save();
      })
      
    </script>
  </body>
</html>