<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/custom.css">
  </head>
  <body>
    <div class="container d-flex justify-content-center" style="height: 100vh;" id="registrazione">
      <form name="regForm" class="p-2" id="reg-form">
        <div class="mb-2">
          <p style="color: white; font-size: 25pt;" class="mt-3" >Crea account</p>
          <p style="color: white; font-size: 15pt;" >E-mail</p>
          <input placeholder="Inserire la tua mail" type="email" class="form-control" id="email" name="email" aria-describedby="emailHelp">
          <div id="emailHelpBlock" class="form-text mt-3 mb-3 d-none" style="color: red;">*Email gia in uso</div>
        </div>
        <p style="color: white; font-size: 15pt;" >Password</p>
        <div class="mb-2">
          <input placeholder="Password" type="password" class="form-control" id="password" name="password">
        </div>
        <div id="passwordHelpBlock" class="form-text mt-3 mb-3" style="color: white;">*La tua password deve contenere almeno 8 caretteri, almeno una lettera maiuscola e almeno un carettere speciale</div>
        <p style="color: white; font-size: 15pt;" >Username</p>
        <input placeholder="Scegliere un username" class="form-control" id="username" aria-describedby="emailHelp" name="username">
        <div id="usernameHelpBlock" class="form-text mt-3 mb-3 d-none" style="color: red;">*Username gia in uso</div>
      <div class="row">
        <div class="col">
          <p style="color: white; font-size: 15pt;" class="mt-3" >Data di nascita:</p>
          <input type="date" id="dateStandard" name="dateStandard" class="date">
        </div>
        <div class="col">
          <p style="color: white; font-size: 15pt;" class="mt-3">Market:</p>
          <select class="form-select mb-3" aria-label="Default select example" name="market">
            <option selected>Scegli il paese</option>
            <option value="1">EN</option>
            <option value="2">IT</option>
            <option value="3">ES</option>
            <option value="4">US</option>
          </select>
        </div>
      </div>
    
        <div class="mb-3 mt-3">
          <button type="submit" class="btn w-100" id="crea">Crea</button>
        </div>
          <a href="#" style="text-decoration: underline; color: white;" id="acc">Hai gi√† un'account?</a>
        
      </form>
    </div>

    <div class="mt-4 d-none" id="doporegistrazione">

      <div class="container mt-3">
      <p style="color:grey; font-size: 20pt;" class="mt-4">Aggiungi i tuoi generti musicali preferiti:</p>

        <select class="form-select form-select-lg mb-3" aria-label="Large select example" onchange="addGenre(this.value);" id="sel-gen">
            <option value="" selected>Genres</option>
        </select>

        <ul class="list-group list-group-horizontal ">
            <li class="item d-flex d-none"  id="selected-genres">
                <label class="form-check-label me-2" id="lbl" for="firstRadio">item</label>
                <div role="button" id="close-btn" onclick="this.parentElement.remove();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="white" class="bi bi-x" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                </div>
            </li>
        </ul>
    </div>

    <div class="mb-3 mt-3">
      <button type="submit" class="btn btn-primary" id="add-gen" style="float:right; margin-right:190px">Aggiungi</button>
    </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="JavaScript/func.js"></script>
    <script>
      async function loadGenres() {
          const options =  {
          method: "GET",
          headers: {
              Authorization: localStorage.getItem('api_key')
          }
      }
          fetch('https://api.spotify.com/v1/recommendations/available-genre-seeds',options)
              .then((res) => {
                  if (!res.ok) {
                      if (res.status == 401) {
                          getApiToken()
                              .then((res) => {
                                  localStorage.setItem('api_key', res.token_type+' '+res.access_token);
                              })
                          loadGenres();
                      }
                  } else {
                      return res.json();
                  }
              })
              .then((json) => {
                  console.log(json);
                  let select = document.getElementById('sel-gen');
                  for (let i = 0; i < json.genres.length; i++) {
                      let option = document.createElement('option');
                      option.value = json.genres[i];
                      option.innerHTML = json.genres[i];
                      select.appendChild(option);
                  }
              });

          //console.log(res);
      }
      const list = document.getElementById('selected-genres');
      function addGenre(genre) {
          let clone = list.cloneNode(true);

          clone.getElementsByClassName('form-check-label')[0].innerHTML = genre;
          clone.classList.remove('d-none');
          list.before(clone);
      }
  </script>
    <script>
      let reg_form = document.getElementById('reg-form');

      reg_form.addEventListener('submit', (e) => {
        e.preventDefault();

        const options = {
          method: "POST",
          mode: "cors",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify(
            {
              email: document.forms['regForm']['email'].value, 
              password: document.forms['regForm']['password'].value,
              username: document.forms['regForm']['username'].value,
              date_of_birth: document.forms['regForm']['dateStandard'].value,
              market: document.forms['regForm']['market'].value

            }
          )
        }

        fetch('http://localhost:3000/addUser', options)
            .then((res) => res.json())
            .then((res) => {
              console.log(res);
              if (res.code == 400) {
                if ((res.type)=="email")
                  document.getElementById('emailHelpBlock').classList.remove('d-none');
                else if ((res.type)=="username")
                  document.getElementById('usernameHelpBlock').classList.remove('d-none');
                else if(res.type=="password")
                  document.getElementById('passwordHelpBlock').innerHTML = res.error;
              } else if (res.code == 201) {
                document.getElementById("registrazione").classList.add('d-none');
                document.getElementById("doporegistrazione").classList.remove('d-none');
                loadGenres();
              }
            })
            .catch((err) => console.log(err));
      });
    </script>
  </body>
</html>